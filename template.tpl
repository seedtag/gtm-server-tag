___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Seedtag - Server Tag",
  "categories": [
    "ADVERTISING",
    "CONVERSIONS",
    "LEAD_GENERATION",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Seedtag",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "This templates adapts GA4 events to Seedtag tracking system.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pid",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^[0-9]+-[0-9a-f]{20}$"
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Enter your template code here.
const sendHttpRequest = require('sendHttpRequest');
const encodeUriComponent = require('encodeUriComponent');
const JSON = require('JSON');
const getEventData = require('getEventData');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const generateRandom = require('generateRandom');
const getRemoteAddress = require('getRemoteAddress');
const sendPixelFromBrowser = require('sendPixelFromBrowser');

const event_name = getEventData('event_name');

if (event_name !== 'page_view' && event_name !== 'user_engagement' && event_name !== 'seedtag.lead') {
  data.gtmOnSuccess(); // Nothing to do
  return;
} 

let action = 'visit'; // default for page_view event
if (event_name === 'user_engagement') {
  action = 'close';
} else if (event_name === 'seedtag.lead') {
  action = 'lead';
}

let requestUrl = 'https://t.kmtx.io/s?' +
    'pid=' + enc(data.pid) +
    '&cid=' + enc(getEventData('client_id')) +
    '&eid=' + uuid() +
    '&a=' + action +
    '&ed=' + enc(getEventData('event_data')) +
    '&v=gtm_server_1' +
    '&url=' + enc(getEventData('page_location')) +
    '&ref=' + enc(getRequestHeader('referer')) + 
    '&ts=' + getTimestampMillis() +
    '&sr=' + enc(getEventData('screen_resolution')) +  
    '&vp=' + enc(getEventData('viewport_size')) +
    '&trk=trkid' +
    '&t=xhr';

sendHttpRequest(requestUrl, { 
  headers: {
    'X-Forwarded-For': getRemoteAddress(),
    'User-Agent': getEventData('user_agent'),
  },
  method: 'GET' 
}).then((result) => {
  if (result.statusCode >= 200 && result.statusCode < 400) {
    if (result.body !== undefined) {
      const obj = JSON.parse(result.body);
      if (obj.url !== undefined && obj.url !== "") {
        sendPixelFromBrowser(obj.url);
      }
    }
    
    data.gtmOnSuccess();
  } else {
    data.gtmOnFailure();
  }
}).catch((error) => {
  data.gtmOnFailure(); 
});

function enc(input) {
  input = input || '';
  return encodeUriComponent(input);
}

// Function to generate random UUIDv4
function uuid() {
    var chars = '0123456789abcdefghijklmnopqrstuvwxyz'.split('');
    var uuid = [];
    var rnd = 0;
    var r;
    for (var i = 0; i < 36; i++) {
        if (i == 8 || i == 13 || i == 18 || i == 23) {
            uuid[i] = '-';
        } else if (i == 14) {
            uuid[i] = '4';
        } else {
            if (rnd <= 2) rnd = 33554432 + ((generateRandom(0, 100000) / 100000) * 16777216) | 0;
            r = rnd & 15;
            rnd = rnd >> 4;
            uuid[i] = chars[(i == 19) ? (r & 3) | 8 : r];
        }
    }
    return uuid.join('');
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "event_name"
              },
              {
                "type": 1,
                "string": "client_id"
              },
              {
                "type": 1,
                "string": "page_location"
              },
              {
                "type": 1,
                "string": "event_data"
              },
              {
                "type": 1,
                "string": "screen_resolution"
              },
              {
                "type": 1,
                "string": "viewport_size"
              },
              {
                "type": 1,
                "string": "user_agent"
              }
            ]
          }
        },
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "forwarded"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "x-forwarded-for"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "remoteAddressAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://t.kmtx.io/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel_from_browser",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: GA event not adapted
  code: |-
    const mockData = {
      pid: '1-ade456ef78ade456ef78',
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Check API calls
    assertApi("getEventData").wasCalled();
    assertApi("getRequestHeader").wasNotCalled();
    assertApi("getRemoteAddress").wasNotCalled();
    assertApi("sendHttpRequest").wasNotCalled();
    assertApi("sendPixelFromBrowser").wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: GA event page_view
  code: |-
    const mockData = {
      pid: '1-ade456ef78ade456ef78',
    };

    gaEventName = 'page_view';

    // Call runCode to run the template's code.
    runCode(mockData);

    // Check API calls
    callLater(() => {
      assertApi("getEventData").wasCalled();
      assertApi("getRequestHeader").wasCalled();
      assertApi("getRemoteAddress").wasCalled();
      assertApi("sendHttpRequest").wasCalled();
      assertApi("sendPixelFromBrowser").wasNotCalled();
      assertApi('gtmOnSuccess').wasCalled();
      assertApi('gtmOnFailure').wasNotCalled();

      assertThat(sendHttpRequestUrl).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=client_id&eid=f41000f4-1000-4f41-800f-41000f41000f&a=visit&ed=event_data&v=gtm_server_1&url=https%3A%2F%2Ftest.com%2Ftest&ref=https%3A%2F%2Freferer.me&ts=1&sr=1440x900&vp=800x600&trk=trkid&t=xhr');
    });
- name: GA event user_engagement
  code: |-
    const mockData = {
      pid: '1-ade456ef78ade456ef78',
    };

    gaEventName = 'user_engagement';

    // Call runCode to run the template's code.
    runCode(mockData);

    // Check API calls
    callLater(() => {
      assertApi("getEventData").wasCalled();
      assertApi("getRequestHeader").wasCalled();
      assertApi("getRemoteAddress").wasCalled();
      assertApi("sendHttpRequest").wasCalled();
      assertApi("sendPixelFromBrowser").wasNotCalled();
      assertApi('gtmOnSuccess').wasCalled();
      assertApi('gtmOnFailure').wasNotCalled();

      assertThat(sendHttpRequestUrl).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=client_id&eid=f41000f4-1000-4f41-800f-41000f41000f&a=close&ed=event_data&v=gtm_server_1&url=https%3A%2F%2Ftest.com%2Ftest&ref=https%3A%2F%2Freferer.me&ts=1&sr=1440x900&vp=800x600&trk=trkid&t=xhr');
    });
- name: GA event seedtag lead
  code: |-
    const mockData = {
      pid: '1-ade456ef78ade456ef78',
    };

    gaEventName = 'seedtag.lead';

    // Call runCode to run the template's code.
    runCode(mockData);

    // Check API calls
    callLater(() => {
      assertApi("getEventData").wasCalled();
      assertApi("getRequestHeader").wasCalled();
      assertApi("getRemoteAddress").wasCalled();
      assertApi("sendHttpRequest").wasCalled();
      assertApi("sendPixelFromBrowser").wasNotCalled();
      assertApi('gtmOnSuccess').wasCalled();
      assertApi('gtmOnFailure').wasNotCalled();

      assertThat(sendHttpRequestUrl).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=client_id&eid=f41000f4-1000-4f41-800f-41000f41000f&a=lead&ed=event_data&v=gtm_server_1&url=https%3A%2F%2Ftest.com%2Ftest&ref=https%3A%2F%2Freferer.me&ts=1&sr=1440x900&vp=800x600&trk=trkid&t=xhr');
    });
- name: GA event page_view with redirect
  code: "const JSON1 = require('JSON');\n\nconst mockData = {\n  pid: '1-ade456ef78ade456ef78',\n\
    };\n\ngaEventName = 'page_view';\n\nmock('sendHttpRequest', function(url, options,\
    \ body) {\n  sendHttpRequestUrl = url;\n  var result = {};\n  \n  result.headers\
    \ = {};\n  result.body = JSON1.stringify({url: 'https://redirect.me'});\n  result.statusCode\
    \ = 200;\n  \n  return Promise1.create((resolve, reject) => {\n    resolve(result);\n\
    \  });\n});\n\nvar sendPixelFromBrowserUrl = '';\n\nmock('sendPixelFromBrowser',\
    \ function(url) {\n  sendPixelFromBrowserUrl = url;\n  var result = true;\n\n\
    \  return Promise1.create((resolve, reject) => {\n    resolve(result);\n  });\n\
    });\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\n// Check\
    \ API calls\ncallLater(() => {\n  assertApi(\"getEventData\").wasCalled();\n \
    \ assertApi(\"getRequestHeader\").wasCalled();\n  assertApi(\"getRemoteAddress\"\
    ).wasCalled();\n  assertApi(\"sendHttpRequest\").wasCalled();\n  assertApi(\"\
    sendPixelFromBrowser\").wasCalled();\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n\n  assertThat(sendHttpRequestUrl).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=client_id&eid=f41000f4-1000-4f41-800f-41000f41000f&a=visit&ed=event_data&v=gtm_server_1&url=https%3A%2F%2Ftest.com%2Ftest&ref=https%3A%2F%2Freferer.me&ts=1&sr=1440x900&vp=800x600&trk=trkid&t=xhr');\n\
    \n  assertThat(sendPixelFromBrowserUrl).isEqualTo('https://redirect.me');\n});\n\
    \n"
- name: GA event page_view with error
  code: "const mockData = {\n  pid: '1-ade456ef78ade456ef78',\n};\n\ngaEventName =\
    \ 'page_view';\n\nmock('sendHttpRequest', function(url, options, body) {\n  sendHttpRequestUrl\
    \ = url;\n  var result = {};\n  \n  result.headers = {};\n  result.statusCode\
    \ = 500;\n  \n  return Promise1.create((resolve, reject) => {\n    resolve(result);\n\
    \  });\n});\n\n// Call runCode to run the template's code.\nrunCode(mockData);\n\
    \n// Check API calls\ncallLater(() => {\n  assertApi(\"getEventData\").wasCalled();\n\
    \  assertApi(\"getRequestHeader\").wasCalled();\n  assertApi(\"getRemoteAddress\"\
    ).wasCalled();\n  assertApi(\"sendHttpRequest\").wasCalled();\n  assertApi(\"\
    sendPixelFromBrowser\").wasNotCalled();\n  assertApi('gtmOnSuccess').wasNotCalled();\n\
    \  assertApi('gtmOnFailure').wasCalled();\n\n  assertThat(sendHttpRequestUrl).isEqualTo('https://t.kmtx.io/s?pid=1-ade456ef78ade456ef78&cid=client_id&eid=f41000f4-1000-4f41-800f-41000f41000f&a=visit&ed=event_data&v=gtm_server_1&url=https%3A%2F%2Ftest.com%2Ftest&ref=https%3A%2F%2Freferer.me&ts=1&sr=1440x900&vp=800x600&trk=trkid&t=xhr');\n\
    });"
setup: "const Promise1 = require(\"Promise\");\nconst callLater = require('callLater');\n\
  \nmock('generateRandom', 2);\n\nmock('getTimestampMillis', 1);\n\nvar genUUID =\
  \ 'f41000f4-1000-4f41-800f-41000f41000f';\n\nvar gaEventName = 'scroll';\n\nvar\
  \ sendHttpRequestUrl = '';\n\nmock('getEventData', function(keypath) {\n  if (keypath\
  \ === 'event_name') {\n    return gaEventName;\n  }\n  \n  if (keypath === 'client_id')\
  \ {\n    return 'client_id';\n  }  \n\n  if (keypath === 'page_location') {\n  \
  \  return 'https://test.com/test';\n  }  \n\n  if (keypath === 'event_data') {\n\
  \    return 'event_data';\n  }\n  \n  if (keypath === 'screen_resolution') {\n \
  \   return '1440x900';\n  } \n  \n  if (keypath === 'viewport_size') {\n    return\
  \ '800x600';\n  } \n  \n  if (keypath === 'user_agent') {\n    return 'Mozilla/5.0\
  \ (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko)';\n\
  \  }   \n  \n  fail('getEventData with unknown keypath');\n});\n\nmock('getRequestHeader',\
  \ function(headerName) {\n  if (headerName === 'referer') {\n    return 'https://referer.me';\n\
  \  }\n  \n  fail('getEventData with unknown headerName');\n});\n\nmock('getRemoteAddress',\
  \ '12.345.67.890');\n\nmock('sendHttpRequest', function(url, options, body) {\n\
  \  sendHttpRequestUrl = url;\n  var result = {};\n  \n  result.headers = {};\n \
  \ result.statusCode = 200;\n  \n  return Promise1.create((resolve, reject) => {\n\
  \    resolve(result);\n  });\n});\n"


___NOTES___

Created on 12/04/2024, 15:24:52


